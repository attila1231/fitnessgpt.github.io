<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
  <meta charset="UTF-8" />
  <title>FitnessGPT</title>
  
  <link rel="icon" type="image/x-icon" href="fitnessgpt.png">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(to right, #222222   , #2d2d2d);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      color: white;
    }

    #chatbox {
    
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg {
        
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.4;
      word-wrap: break-word;
      animation: blurFadeIn 0.4s ease forwards;
    }

    .user {
      align-self: flex-end;
      background: linear-gradient(to right, #8807eb, #0649e6);
      color: rgb(255, 255, 255);
    }


    .bot {
      align-self: flex-start;
      
      color: white;
    }

    .gradient {
      
      
    }

    #inputbar {
      margin:  auto;
      margin-bottom: 30px;
      padding: 15px;
      text-align: center;
      display: flex;
      width: 70%;
      min-width: 350px;
      max-width: 900px;
      border: rgba(255, 255, 255, 0.599), 1px solid;
      border-radius: 6px;
    }
    

    #input {
      font-family: 'Roboto', sans-serif;
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      margin-right: 10px;
      background: #222;
      color: white;
      outline: none;
      transition: box-shadow 0.2s;
    }
    #input:focus {
      box-shadow: 0 0 0 2px #0649e6;
    }

    

    #send {
        font-family: 'Roboto', sans-serif;
      padding: 12px 18px;
      font-size: 16px;
      background: linear-gradient(to right, #8807eb, #0649e6);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      color: #ffffff;
    }
    #send:hover {
      background: linear-gradient(to right, #6906b4, #0538b0);
    }
    #typing-indicator {
  font-style: italic;
  color: #aaa;
  margin: 10px 0;
  animation: fadeIn 0.3s ease;
}
#greeting{
 
  margin: auto;
  padding: 10px;
  text-align: center;
  font-size:32px;
  background: -webkit-linear-gradient(right,#eb07e4, #06aae6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: bold;
  animation: blurFadeIn 0.5s ease-in-out;
  opacity: 1;

}

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes blurFadeIn {
  0% {
    filter: blur(6px);
    opacity: 0;
  }
  100% {
    filter: blur(0);
    opacity: 1;
  }
}
  </style>
</head>
<body>
  <div id="chatbox">
    <div id="greeting">Welcome to FitnessGPT :)</div>
  </div>
  <div id="typing-indicator" style="display: none;">FitnessGPT is thinking...</div>
  <div id="inputbar">
    <input id="input" placeholder="Ask FitnessGPT anything..." />
    <button id="send" onclick="sendMessage()">Send</button>
  </div>
  
  <script>
    const user_id = "user_" + Math.random().toString(36).substr(2, 9);

    const chatbox = document.getElementById("chatbox");
    const input = document.getElementById("input");
    input.addEventListener("keydown", function (event) {
  if (event.key === "Enter" && !event.shiftKey) {
    event.preventDefault(); // prevent newline
    sendMessage();
  }
});

    // On load: reset conversation and show greeting
    window.onload = async () => {
      await fetch("https://fitnessgpt-fdw9.onrender.com/reset", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id })
      });

      const data = await res.json();
      
      typeMessage("FitnessGPT", data.reply, "bot gradient");
    };

    async function sendMessage() {
  document.getElementById("greeting").style.display = "none";
  const msg = input.value.trim();
  if (!msg) return;

  addMessage("You", msg, "user");
  input.value = "";

  // Show typing indicator
  const typing = document.getElementById("typing-indicator");
  typing.style.display = "block";

  // âœ… Force DOM to update before continuing
  await new Promise(requestAnimationFrame);

  try {
    const res = await fetch("https://fitnessgpt-fdw9.onrender.com/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id, message: msg })
    });
    
    const data = await res.json();

    // Hide typing indicator
    typing.style.display = "none";

    // Show assistant message with animation
    
    typeMessage("FitnessGPT", data.reply, "bot gradient");
  } catch (e) {
    typing.style.display = "none";
    addMessage("FitnessGPT", "Sorry, something went wrong.", "bot");
  }
}

    function addMessage(sender, text, cls) {
      const div = document.createElement("div");
      div.className = `msg ${cls}`;
      div.innerHTML = `<strong>${sender}</strong><br>${text}`;
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function typeMessage(sender, text, cls) {
  const div = document.createElement("div");
  div.className = `msg ${cls}`;
  div.innerHTML = `<strong>${sender}</strong><br>`;

  const span = document.createElement("span");
  div.appendChild(span);
  chatbox.appendChild(div);
  chatbox.scrollTop = chatbox.scrollHeight;

  let i = 0;

  const interval = setInterval(() => {
    const char = text.charAt(i++);

    if (char === "\n") {
      span.appendChild(document.createElement("br"));
    } else {
      span.appendChild(document.createTextNode(char));
    }

    chatbox.scrollTop = chatbox.scrollHeight;

    if (i >= text.length) {
      clearInterval(interval);
      // Replace typed plain text with formatted HTML
      span.innerHTML = chatgptOutputToHtml(text);
    }
  }, 8);
}

function chatgptOutputToHtml(text) {
  let html = text
    .replace(/&/g, "&amp;") // escape before parsing HTML
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");

  // Code blocks
  html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (_, lang, code) => {
    return `<pre><code>${code.trim()}</code></pre>`;
  });

  // Inline code
  html = html.replace(/`([^`\n]+?)`/g, '<code>$1</code>');

  // Bold-italic: ***text*** or ___text___
  html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
  html = html.replace(/___(.*?)___/g, '<strong><em>$1</em></strong>');

  // Bold: **text** or __text__
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');

  // Italic: *text* or _text_
  html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
  html = html.replace(/_(.*?)_/g, '<em>$1</em>');

  // Line breaks
  html = html.replace(/\n/g, '<br>');

  return html;
}


  </script>
</body>
</html>
